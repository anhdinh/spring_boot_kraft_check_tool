<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Kafka Real-time Dashboard</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background:#eef2f3;
            min-height:100vh;
            display:flex;
            justify-content:center;
            align-items:center;
            padding: 20px;
        }
        .container-box {
            display: flex;
            gap: 20px;
            max-width: 1000px;
            width: 100%;
        }
        .card {
            flex: 1;
            border-radius: 12px;
            height: 550px;
            display: flex;
            flex-direction: column;
        }
        .header-bar {
            background: linear-gradient(135deg,#007bff,#00c6ff);
            padding:18px;
            color:white;
            border-radius: 12px 12px 0 0;
        }
        .message-stream {
            flex-grow: 1;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 15px;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            display: flex;
            flex-direction: column; /* scroll xu·ªëng d∆∞·ªõi */
        }
        .msg-item {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
            width: 100%;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .msg-left .bubble {
            background: #ffffff;
            align-self: flex-start;
            border-radius: 12px 12px 12px 0;
            padding: 8px 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .msg-right .bubble {
            background: #DCF8C6;
            align-self: flex-end;
            border-radius: 12px 12px 0 12px;
            padding: 8px 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .msg-header {
            font-size: 11px;
            color: #888;
            margin-bottom: 2px;
        }
        .msg-header strong {
            color: #333;
        }
        .status-dot {
            height: 10px;
            width: 10px;
            background-color: #28a745;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
    </style>
</head>
<body>

<div class="container-box">
    <!-- Sender Card -->
    <div class="card shadow-lg">
        <div class="header-bar">
            <h3 class="m-0">Sender</h3>
            <div style="font-size:13px;opacity:.75">G·ª≠i message v√†o Kafka</div>
        </div>
        <div class="p-4">
            <div id="alertBox" style="display:none" class="alert alert-success"></div>
            <div class="mb-3">
                <label class="form-label">üë§ User</label>
                <label id="lb_key" for="key"></label><input style="display:none" id="key" class="form-control" placeholder="vd: user-1" required>
            </div>
            <div class="mb-3">
                <label class="form-label">‚úâ Message</label>
                <label for="message"></label><textarea
                        id="message"
                        rows="3"
                        class="form-control"
                        placeholder="Nh·∫≠p n·ªôi dung..."
                        onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendKafka(); }" required></textarea>
            </div>
            <button class="btn btn-primary w-100 fw-bold" onclick="sendKafka()">G·ª¨I TIN</button>
            <p class="text-center mt-3 text-muted small">Topic: <b>chat-room</b></p>
        </div>
    </div>

    <!-- Receiver Card -->
    <div class="card shadow-lg">
        <div class="header-bar bg-dark" style="background: linear-gradient(135deg,#343a40,#6c757d);">
            <h3 class="m-0">Receiver</h3>
            <div style="font-size:13px;opacity:.75">
                <span class="status-dot"></span> ƒêang ch·ªù tin nh·∫Øn t·ª´ kafka...
            </div>
        </div>
        <div id="streamBox" class="message-stream">
            <div class="text-center text-muted mt-5" id="emptyState">Ch∆∞a c√≥ tin nh·∫Øn m·ªõi...</div>
        </div>
    </div>
</div>

<script>
    const users = ["Cua ·∫©n s·ªπ",
        "R·∫Øn ƒêu√¥i Chu√¥ng", "M√®o X·∫£o Quy·ªát", "C√°o Gi√†", "ƒê·∫°i B√†ng L·ª≠a", "H·ªï G·∫ßm Vang",
        "G·∫•u L√¥i Th√¥i", "Kh·ªâ L√°ch Chanh", "R√πa T·ªëc ƒê·ªô", "C√° M·∫≠p ƒÇn Chay", "S√≥c Nhanh Nh·∫πn",
        "Voi Tr·∫ßm T∆∞", "C√∫ M√®o Th√¥ng Th√°i", "Ng·ª±a Hoang D√£", "S√≥i C√¥ ƒê·ªôc", "L∆∞·ªùi Ch·∫≠m Ch·∫°p",
        "Ki·∫øn Ki√™n Tr√¨", "B√°o ƒê·ªëm Ch·ªõp Nho√°ng", "L·∫°c ƒê√† Ki√™n C∆∞·ªùng", "Th·ªè Ng√¢y Ng√¥", "Chim ∆Øng Vƒ© ƒê·∫°i",
        "Heo L·∫°c Quan", "Chu·ªôt Ti·∫øu T·ª•y", "V·ªãt Lanh Chanh", "Thanh X√† Nghi·ªát Ng√£", "B·∫°ch Tu·ªôc",
        "T√™ Gi√°c L·∫°nh L√πng", "S∆∞ T·ª≠ Oai Nghi", "B·ªç C·∫°p Hi·ªÉm ƒê·ªôc", "Thi√™n Nga Ki√™u K·ª≥", "Kh·ªßng Long B·∫°o Ch√∫a"
    ];

    function generateKey() {
        const keyInput = document.getElementById("key");
        const randomIndex = Math.floor(Math.random() * users.length);
        const selectedUser = users[randomIndex];
        const generatedKey = selectedUser + "_" + Math.floor(Math.random() * 100);
        keyInput.value = generatedKey;
    }

    // G·ªçi h√†m ngay khi trang web v·ª´a load xong
    window.onload = generateKey;

    const keyInput = document.getElementById("key");
    const keyLabel = document.getElementById("lb_key");
    // --- PH·∫¶N G·ª¨I TIN ---
    async function sendKafka() {
        const payload = {
            key: keyInput.value,
            message: document.getElementById("message").value
        };
        if (!payload.message) {
            return;
        }

        if(!payload.key){
            alert("user kh√¥ng th·ªÉ ƒë·ªÉ tr·ªëng!")
            return;
        }else{
            keyLabel.innerText = keyInput.value;
            keyInput.style.display = "none";
        }
        try {
            const res = await fetch("/send", {
                method:"POST",
                headers:{ "Content-Type":"application/json" },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            // const alert = document.getElementById("alertBox");
            // alert.innerText = "G·ª≠i th√†nh c√¥ng!";
            // alert.style.display = "block";
            // setTimeout(()=> alert.style.display="none", 3000);
            document.getElementById("message").value = "";
        } catch (err) {
            console.error("L·ªói g·ª≠i tin:", err);
        }
    }

    // --- PH·∫¶N NH·∫¨N TIN ---
    let lastMessageContent = "";
    let lastMessageTime = 0;
    let currentUser = "";



    function setupStream() {
        if (window.eventSource) window.eventSource.close();

        const eventSource = new EventSource("/api/stream");
        window.eventSource = eventSource;

        eventSource.addEventListener("message", (event) => {
            currentUser = document.getElementById("key").value
            const rawData = event.data;

            if (!rawData || rawData.toLowerCase().includes("heartbeat")) return;

            const now = Date.now();
            if (rawData === lastMessageContent && (now - lastMessageTime) < 1000) return;
            lastMessageContent = rawData;
            lastMessageTime = now;

            let messageText = rawData;
            let user = "";
            try {
                const parsed = JSON.parse(rawData);
                if (parsed.message) messageText = parsed.message;
                if (parsed.user) user = parsed.user;
            } catch (err) {}

            const streamBox = document.getElementById("streamBox");
            const emptyState = document.getElementById("emptyState");
            if (emptyState) emptyState.remove();

            const msgDiv = document.createElement("div");
            const isCurrentUser = currentUser === user;
            msgDiv.className = isCurrentUser ? "msg-item msg-right" : "msg-item msg-left";

            msgDiv.innerHTML = `
                <div class="msg-header" style="text-align: ${isCurrentUser ? 'right' : 'left'};">
                    <strong>${user || "Anonymous"}</strong> ‚Ä¢ ${new Date().toLocaleTimeString()}
                </div>
                <div class="bubble">
                    ${messageText}
                </div>
            `;

            streamBox.appendChild(msgDiv);
            streamBox.scrollTop = streamBox.scrollHeight; // scroll xu·ªëng tin m·ªõi

            // Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng hi·ªÉn th·ªã
            if (streamBox.children.length > 10000) {
                streamBox.removeChild(streamBox.firstChild);
            }
        });

        eventSource.onerror = () => {
            console.warn("Stream ng·∫Øt k·∫øt n·ªëi, ƒëang ch·ªù t·ª± ƒë·ªông k·∫øt n·ªëi l·∫°i...");
        };
    }

    setupStream();
</script>

</body>
</html>
