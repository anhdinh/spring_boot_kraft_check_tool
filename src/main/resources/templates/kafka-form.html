<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chat-room</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background:#eef2f3;
            min-height:100vh;
            display:flex;
            justify-content:center;
            align-items:center;
            padding: 20px;
        }
        .container-box {
            display: flex;
            gap: 20px;
            max-width: 1000px;
            width: 100%;
        }
        .card {
            flex: 1;
            border-radius: 12px;
            height: 550px;
            display: flex;
            flex-direction: column;
        }
        .header-bar {
            background: linear-gradient(135deg,#007bff,#00c6ff);
            padding:18px;
            color:white;
            border-radius: 12px 12px 0 0;
        }
        .message-stream {
            flex-grow: 1;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 15px;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            display: flex;
            flex-direction: column; /* scroll xu·ªëng d∆∞·ªõi */
        }
        .msg-item {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
            width: 100%;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .msg-left .bubble {
            background: #ffffff;
            align-self: flex-start;
            border-radius: 12px 12px 12px 0;
            padding: 8px 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .msg-right .bubble {
            background: #DCF8C6;
            align-self: flex-end;
            border-radius: 12px 12px 0 12px;
            padding: 8px 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .msg-header {
            font-size: 11px;
            color: #888;
            margin-bottom: 2px;
        }
        .msg-header strong {
            color: #333;
        }
        .status-dot {
            height: 10px;
            width: 10px;
            background-color: #28a745;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
    </style>
</head>
<body>

<div class="container-box">
    <!-- Sender Card -->
    <div class="card shadow-lg">
        <div class="header-bar">
            <h3 class="m-0">Sender</h3>
            <div style="font-size:13px;opacity:.75">G·ª≠i message</div>
        </div>
        <div class="p-4">
            <div id="alertBox" style="display:none" class="alert alert-success"></div>
            <div class="mb-3">
                <label class="form-label">üë§ User</label>
                <label id="lb_key" for="key"></label><input style="display:none" id="key" class="form-control" placeholder="vd: user-1" required>
            </div>
            <div class="mb-3">
                <label class="form-label">‚úâ Message</label>
                <label for="message"></label><textarea
                        id="message"
                        rows="3"
                        class="form-control"
                        placeholder="Nh·∫≠p n·ªôi dung..."
                        onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendKafka(); }" required></textarea>
            </div>
            <button class="btn btn-primary w-100 fw-bold" onclick="sendKafka()">G·ª¨I TIN</button>
            <p class="text-center mt-3 text-muted small">Topic: <b>chat-room</b></p>
        </div>
    </div>

    <!-- Receiver Card -->
    <div class="card shadow-lg">
        <div class="header-bar bg-dark" style="background: linear-gradient(135deg,#343a40,#6c757d);">
            <h3 class="m-0">Receiver</h3>
            <div style="font-size:13px;opacity:.75">
                <span class="status-dot"></span> ƒêang ch·ªù tin nh·∫Øn ...
            </div>
        </div>
        <div id="streamBox" class="message-stream">
            <div class="text-center text-muted mt-5" id="emptyState">Ch∆∞a c√≥ tin nh·∫Øn m·ªõi...</div>
        </div>
    </div>
</div>

<script>
    const users = ["Cua ·∫©n s·ªπ", "R·∫Øn ƒêu√¥i Chu√¥ng", "M√®o X·∫£o Quy·ªát", "C√°o Gi√†", "ƒê·∫°i B√†ng L·ª≠a", "H·ªï G·∫ßm Vang", "G·∫•u L√¥i Th√¥i", "Kh·ªâ L√°ch Chanh", "R√πa T·ªëc ƒê·ªô", "C√° M·∫≠p ƒÇn Chay", "S√≥c Nhanh Nh·∫πn", "Voi Tr·∫ßm T∆∞", "C√∫ M√®o Th√¥ng Th√°i", "Ng·ª±a Hoang D√£", "S√≥i C√¥ ƒê·ªôc", "L∆∞·ªùi Ch·∫≠m Ch·∫°p", "Ki·∫øn Ki√™n Tr√¨", "B√°o ƒê·ªëm Ch·ªõp Nho√°ng", "L·∫°c ƒê√† Ki√™n C∆∞·ªùng", "Th·ªè Ng√¢y Ng√¥", "Chim ∆Øng Vƒ© ƒê·∫°i", "Heo L·∫°c Quan", "Chu·ªôt Ti·∫øu T·ª•y", "V·ªãt Lanh Chanh", "Thanh X√† Nghi·ªát Ng√£", "B·∫°ch Tu·ªôc", "T√™ Gi√°c L·∫°nh L√πng", "S∆∞ T·ª≠ Oai Nghi", "B·ªç C·∫°p Hi·ªÉm ƒê·ªôc", "Thi√™n Nga Ki√™u K·ª≥", "Kh·ªßng Long B·∫°o Ch√∫a"];

    let currentUser = "";

    // 1. Kh·ªüi t·∫°o User ng·∫´u nhi√™n
    function generateKey() {
        const keyInput = document.getElementById("key");
        const keyLb = document.getElementById("lb_key");
        const randomIndex = Math.floor(Math.random() * users.length);
        currentUser = users[randomIndex] + "_" + Math.floor(Math.random() * 100);
        keyInput.value = currentUser;
        keyLb.innerText = currentUser;
    }

    // 2. H√†m v·∫Ω tin nh·∫Øn l√™n m√†n h√¨nh (D√πng chung cho c·∫£ 2 ngu·ªìn)
    function renderMessage(user, messageText, timestamp, isHistory = false) {
        const streamBox = document.getElementById("streamBox");
        const emptyState = document.getElementById("emptyState");
        if (emptyState) emptyState.remove();

        const msgDiv = document.createElement("div");
        const isMe = currentUser === user;
        msgDiv.className = isMe ? "msg-item msg-right" : "msg-item msg-left";

        const time = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();

        msgDiv.innerHTML = `
        <div class="msg-header" style="text-align: ${isMe ? 'right' : 'left'};">
            <strong>${user || "Anonymous"}</strong> ‚Ä¢ ${time}
        </div>
        <div class="bubble">${messageText}</div>
    `;

        if (isHistory) {
            streamBox.prepend(msgDiv); // Tin c≈© load t·ª´ DB ch√®n l√™n ƒë·∫ßu (n·∫øu loop ng∆∞·ª£c)
        } else {
            streamBox.appendChild(msgDiv); // Tin m·ªõi t·ª´ Kafka ch√®n xu·ªëng cu·ªëi
        }
        streamBox.scrollTop = streamBox.scrollHeight;
    }

    // 3. Load 10 tin m·ªõi nh·∫•t t·ª´ MongoDB
    async function loadHistory() {
        try {
            const res = await fetch("/api/latest");
            const data = await res.json();
            // data ƒëang l√† m·ªõi -> c≈©, ta l·∫∑p ƒë·ªÉ hi·ªÉn th·ªã
            data.forEach(msg => {
                renderMessage(msg.user, msg.message, msg.created_time, false);
            });
            // L∆∞u √Ω: data t·ª´ API l√† DESC, khi append b√¨nh th∆∞·ªùng n√≥ s·∫Ω ƒë√∫ng th·ª© t·ª± t·ª´ tr√™n xu·ªëng d∆∞·ªõi
        } catch (err) {
            console.error("L·ªói load l·ªãch s·ª≠:", err);
        }
    }

    // 4. G·ª≠i tin nh·∫Øn
    async function sendKafka() {
        const msgInput = document.getElementById("message");
        const payload = { key: currentUser, message: msgInput.value };

        if (!payload.message) return;

        try {
            await fetch("/send", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            msgInput.value = "";
        } catch (err) {
            console.error("L·ªói g·ª≠i:", err);
        }
    }

    // 5. L·∫Øng nghe lu·ªìng Real-time (SSE)
    function setupStream() {
        const eventSource = new EventSource("/api/stream");
        eventSource.onmessage = (event) => {
            const rawData = event.data;
            if (!rawData || rawData.includes("heartbeat")) return;
            try {
                const parsed = JSON.parse(rawData);
                renderMessage(parsed.user, parsed.message, null, false);
            } catch (e) {
                renderMessage("System", rawData, null, false);
            }
        };
    }

    // 6. Kh·ªüi ch·∫°y khi load trang
    window.onload = async () => {
        generateKey();
        await loadHistory();
        setupStream();
    };
</script>

</body>
</html>
